<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:json-logger="http://www.mulesoft.org/schema/mule/json-logger" xmlns:wsc="http://www.mulesoft.org/schema/mule/wsc"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/wsc http://www.mulesoft.org/schema/mule/wsc/current/mule-wsc.xsd
http://www.mulesoft.org/schema/mule/json-logger http://www.mulesoft.org/schema/mule/json-logger/current/mule-json-logger.xsd">
	<sub-flow name="get-employees-updateSub_Flow" doc:id="f15010a9-d71a-4af6-a026-a399b05da413" >
		<choice doc:name="Check session" doc:id="25fef3e7-7878-40b4-8801-6398bcbc3539" >
			<when expression='#[vars.sessionId != "" and vars.hasMore == "true"]'>
				<flow-ref doc:name="QueryMore" doc:id="be240f99-bed2-4362-a965-9ba4b6a64477" name="get-employees-update-compound-employee-query-more-Sub_Flow"/>
			</when>
			<when expression="#[vars.hasMore == false]">
				<json-logger:logger doc:name="All page have been retrieved" doc:id="8533b5e6-4ca3-47b4-9bfd-70963f565e0a" config-ref="JSON_Logger_Config" message="All page have been retrieved" tracePoint="AFTER_REQUEST" priority="DEBUG" category="com.louisvuitton.technical" >
					<json-logger:content ><![CDATA[#[import modules::JSONLoggerModule output application/json indent = false ---
{
    payload: JSONLoggerModule::stringifyNonJSON(payload) 
}]]]></json-logger:content>
				</json-logger:logger>
			</when>
			<otherwise >
				<ee:transform doc:name="Set Condition, queryParamList &amp; query" doc:id="54fb546c-a588-4e1a-81b2-0d9b981eb842">
			<ee:message />
			<ee:variables>
				<ee:set-variable variableName="condition"><![CDATA[%dw 2.0
output application/json indent = false
fun formatDate(date) = date as DateTime as String {format: "yyyy-MM-dd"} as Date default ""
var currentDate = formatDate(now())
---
"last_modified_on > to_datetime('$(vars.lastModifiedDateTime)') AND EFFECTIVE_END_DATE = to_date('$(currentDate)','YYYY-MM-DD')"]]></ee:set-variable>
				<ee:set-variable variableName="query"><![CDATA[%dw 2.0
output application/json indent = false
---
payload.queryString joinBy  " ,"]]></ee:set-variable>
						<ee:set-variable variableName="queryParamsList" ><![CDATA[%dw 2.0
output application/json indent = false
---
payload.queryParam]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
				<flow-ref doc:name="compound-employee-login" doc:id="243a9134-3045-435f-bab9-2359245c2eaa" name="compound-employee-login" />
				<ee:transform doc:name="Build Query, , set queryResult" doc:id="3f1246e4-6b11-463a-b022-95b774edeceb">
			<ee:message>
						<ee:set-payload resource="dwl/getEmployeesUpdate/buildQueryEmployees.dwl" />
			</ee:message>
			<ee:variables>
				<ee:set-variable variableName="queryResult"><![CDATA[%dw 2.0
output application/json indent = false
---
[]]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
				<json-logger:logger doc:name="Before Query CompoundEmployee" doc:id="53e1e475-6a8c-4782-a850-1d01ef1f31af" config-ref="JSON_Logger_Config" message="Before Query CompoundEmployee" tracePoint="AFTER_REQUEST" priority="DEBUG" category="com.louisvuitton.technical">
					<json-logger:content><![CDATA[#[import modules::JSONLoggerModule output application/json indent = false ---
{
    payload: JSONLoggerModule::stringifyNonJSON(payload) 
}]]]></json-logger:content>
				</json-logger:logger>
				<wsc:consume operation="query" doc:name="Query CompoundEmployee" doc:id="02903c1b-cc2d-44a9-ac1d-07d0327eb0bd" config-ref="successfactors-ws-consumer-config-operations">
			<wsc:transport-headers>
				<wsc:transport-header key="Cookie" value='#["JSESSIONID=" ++ (vars.loginSessionId) as String]' />
			</wsc:transport-headers>
		</wsc:consume>
				<ee:transform doc:name="Set Response" doc:id="56bb590d-8e25-4cd3-b567-db1981252906" >
					<ee:message >
						<ee:set-payload resource="dwl/getEmployeesUpdate/employeeJSONResponse.dwl" />
					</ee:message>
				</ee:transform>
				<json-logger:logger doc:name="After Query CompoundEmploye" doc:id="cbd71da5-45ff-421f-bf8e-d41ecdb6d299" config-ref="JSON_Logger_Config" message="After Query CompoundEmploye" tracePoint="AFTER_REQUEST" priority="DEBUG" category="com.louisvuitton.technical">
					<json-logger:content><![CDATA[#[import modules::JSONLoggerModule output application/json indent = false ---
{
    payload: JSONLoggerModule::stringifyNonJSON(payload) 
}]]]></json-logger:content>
				</json-logger:logger>
			</otherwise>
		</choice>
	</sub-flow>
	<sub-flow name="get-employees-update-compound-employee-query-more-Sub_Flow" doc:id="d185bee4-426b-48d3-a386-f3e0768ff96b" >
		<ee:transform doc:name="queryMore body" doc:id="fd4b5ef6-eb8f-4ed1-ace2-27c8d30037e5" >
			<ee:message >
				<ee:set-payload resource="dwl/getEmployeesUpdate/queryMoreBody.dwl" />
			</ee:message>
			<ee:variables >
			</ee:variables>
		</ee:transform>
		<json-logger:logger doc:name="Before Querymore Request" doc:id="d7434c8d-2f98-4859-a140-2686821bcf0e" config-ref="JSON_Logger_Config" message="Before Querymore Request" tracePoint="AFTER_REQUEST" priority="DEBUG" category="com.louisvuitton.technical">
			<json-logger:content><![CDATA[#[import modules::JSONLoggerModule output application/json indent = false ---
{
    payload: JSONLoggerModule::stringifyNonJSON(payload) 
}]]]></json-logger:content>
		</json-logger:logger>
		<wsc:consume operation="queryMore" doc:name="queryMore CompoundEmployee" doc:id="32b28d8c-f540-43af-a2cd-a18a0d3c54f6" config-ref="successfactors-ws-consumer-config-operations" >
			<wsc:transport-headers >
				<wsc:transport-header key="Cookie" value='#["JSESSIONID=" ++ (vars.loginSessionId) as String]' />
			</wsc:transport-headers>
		</wsc:consume>
		<ee:transform doc:name="Set Response" doc:id="e70be143-fe04-45aa-ab9b-6dbb23c8abb1">
			<ee:message>
				<ee:set-payload resource="dwl/getEmployeesUpdate/employeeJSONResponse.dwl" />
			</ee:message>
		</ee:transform>
		<json-logger:logger doc:name="After Querymore Request" doc:id="b0f8a5ad-d642-444d-97e7-97378d47194d" config-ref="JSON_Logger_Config" message="After Querymore Request" tracePoint="AFTER_REQUEST" priority="DEBUG" category="com.louisvuitton.technical" >
			<json-logger:content ><![CDATA[#[import modules::JSONLoggerModule output application/json indent = false ---
{
    payload: JSONLoggerModule::stringifyNonJSON(payload) 
}]]]></json-logger:content>
		</json-logger:logger>
	</sub-flow>
</mule>
