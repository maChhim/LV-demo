<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:os="http://www.mulesoft.org/schema/mule/os" xmlns:json-logger="http://www.mulesoft.org/schema/mule/json-logger"
	xmlns:wsc="http://www.mulesoft.org/schema/mule/wsc"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/wsc http://www.mulesoft.org/schema/mule/wsc/current/mule-wsc.xsd
http://www.mulesoft.org/schema/mule/json-logger http://www.mulesoft.org/schema/mule/json-logger/current/mule-json-logger.xsd
http://www.mulesoft.org/schema/mule/os http://www.mulesoft.org/schema/mule/os/current/mule-os.xsd">
	<sub-flow name="compound-employee-login" doc:id="f72ef6a9-5102-4443-a315-b9f8d82ce024" >
		<os:contains doc:name="Obj key=loginSessionId" doc:id="b581dd1a-ee68-41bf-9770-4ff6cc64b202" key="loginSessionId" objectStore="Object_store" target="loginSessionId_stored" />
		<choice doc:name="loginSessionId_stored ?" doc:id="ac4a6472-aef6-49ea-a7d3-70e9c8e85f3b" >
			<when expression="#[not (vars.loginSessionId_stored)]">
				<until-successful maxRetries="${untilSuccessful.maxRetries}" doc:name="Until Successful" doc:id="67c43522-d6b3-48ea-9a39-27e9b99f6da8">
			<try doc:name="Try" doc:id="7eb89e87-8244-4858-bd4a-e5aa66c28900">
				<ee:transform doc:name="Set Credentials" doc:id="4af06181-8e6f-4ed3-949d-bc0b37bf3fe8">
			<ee:message>
			</ee:message>
					<ee:variables>
						<ee:set-variable resource="dwl/setCredentials.dwl" variableName="credentials" />
					</ee:variables>
		</ee:transform>
				<json-logger:logger doc:name="Before Login Request" doc:id="a98ce0b6-80a1-4038-b925-ed8b594371af" config-ref="JSON_Logger_Config" message="Before Login Request" tracePoint="AFTER_REQUEST" priority="DEBUG" category="com.louisvuitton.technical">
		</json-logger:logger>
						<wsc:consume operation="login" doc:name="Login" doc:id="d3e5c0e5-2e3c-4450-90d0-dfe3ea9c725e" config-ref="successfactors-ws-consumer-config-login" target="loginSessionId">
					<wsc:message>
						<wsc:body><![CDATA[#[vars.credentials]]]></wsc:body>
					</wsc:message>
				</wsc:consume>
				<json-logger:logger doc:name="Show SF Login Response" doc:id="b6b298b1-dae7-4d08-ba52-5c92d96f5778" config-ref="JSON_Logger_Config" message="Show SF Login Response" tracePoint="AFTER_REQUEST" priority="DEBUG" category="com.louisvuitton.technical">
			<json-logger:content><![CDATA[#[import modules::JSONLoggerModule output application/json indent = false ---
{
    SessionId: JSONLoggerModule::stringifyNonJSON(vars.loginSessionId) 
}]]]></json-logger:content>
		</json-logger:logger>
						<ee:transform doc:name="Set loginSessionId" doc:id="21665a9a-e091-41ea-8e57-ae60cff6cbd7">
			<ee:message />
			<ee:variables>
				<ee:set-variable variableName="loginSessionId"><![CDATA[%dw 2.0
output application/java
ns urn urn:sfobject.sfapi.successfactors.com
---
vars.loginSessionId.body.urn#loginResponse.urn#result.urn#sessionId default ""]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
				<error-handler>
					<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="54972110-5058-4c98-993c-e1b0ca34a085" type="HTTP:BAD_REQUEST,HTTP:UNAUTHORIZED,HTTP:NOT_FOUND,HTTP:UNSUPPORTED_MEDIA_TYPE," />
				</error-handler>
			</try>
		</until-successful>
				<os:store doc:name="Obj key=token" doc:id="dbac6c2d-37ef-4ccf-a4c6-c59f27cb8519" key="loginSessionId" objectStore="Object_store">
			<os:value><![CDATA[#[vars.loginSessionId]]]></os:value>
		</os:store>
			</when>
			<otherwise >
				<os:retrieve doc:name="Retrieve Token" doc:id="c11e81fa-73ec-491d-a2a0-460db26851f0" key="loginSessionId" objectStore="Object_store" target="loginSessionId" />
				<json-logger:logger doc:name="Token valid - Authentication done" doc:id="77589ec6-e775-4cd2-b1e2-bce290eff0d4" config-ref="JSON_Logger_Config" message="Token valid - Authentication done" tracePoint="FLOW" priority="DEBUG" category="com.lvmh.logger.category.technical" >
					<json-logger:content ><![CDATA[#[import modules::JSONLoggerModule output application/json indent = false ---
{
    SessionId: JSONLoggerModule::stringifyNonJSON(vars.loginSessionId) 
}]]]></json-logger:content>
				</json-logger:logger>
			</otherwise>
		</choice>
	</sub-flow>
</mule>
