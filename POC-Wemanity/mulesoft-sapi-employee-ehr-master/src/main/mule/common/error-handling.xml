<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:json-logger="http://www.mulesoft.org/schema/mule/json-logger"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/json-logger http://www.mulesoft.org/schema/mule/json-logger/current/mule-json-logger.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd">
	
	<!-- define soapfaultResponse variable to true at the begin of the API (before the APIKIT) if soap message and need a soapfault response -->
	
	
	<error-handler name="error-handling-apikit" doc:id="05a9f451-1a7b-41ed-95f9-41796ceb0144" >
		<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="3467fd2e-debe-4539-b3cd-3c09cdc1677f" type="APIKIT:BAD_REQUEST">
			<ee:transform doc:name="Set HTTP Status = 400 &amp; errCode" doc:id="5895d1f8-8021-4777-a381-470eadfb382c">
				<ee:message />
				<ee:variables>
					<ee:set-variable variableName="httpStatus"><![CDATA[%dw 2.0
output application/java
---
400]]></ee:set-variable>
					<ee:set-variable variableName="errCode"><![CDATA[%dw 2.0
output application/java
---
Mule::p('error.badRequest.code')]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<flow-ref doc:name="error-handling:\response" doc:id="536582bd-ae53-4f43-81d2-7dae52b0fa07" name="error-handling:\response" />
		
</on-error-continue>   
		<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="e7a6336f-5463-4f58-bba6-99756a287d65" type="APIKIT:NOT_FOUND" >
			<ee:transform doc:name="Set HTTP Status = 404 &amp; errCode" doc:id="a3e40cc8-728a-4261-8159-105b77c24203">
				<ee:message />
				<ee:variables>
					<ee:set-variable variableName="httpStatus"><![CDATA[%dw 2.0
output application/java
---
404]]></ee:set-variable>
					<ee:set-variable variableName="errCode"><![CDATA[%dw 2.0
output application/java
---
Mule::p('error.notFound.code')]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<flow-ref doc:name="error-handling:\response" doc:id="1241599b-bfb7-41c9-bff5-18e4b2df34b3" name="error-handling:\response" />
		
</on-error-continue>	
		<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="cae6b5e6-7766-4c26-b86d-a35b9f0666a3" type="APIKIT:METHOD_NOT_ALLOWED" >
			<ee:transform doc:name="Set HTTP Status = 405 &amp; errCode" doc:id="3f6b4155-6e45-4007-ae94-0b73f1416933">
				<ee:message />
				<ee:variables>
					<ee:set-variable variableName="httpStatus"><![CDATA[%dw 2.0
output application/java
---
405]]></ee:set-variable>
					<ee:set-variable variableName="errCode"><![CDATA[%dw 2.0
output application/java
---
Mule::p('error.notAllowed.code')]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<flow-ref doc:name="error-handling:\response" doc:id="72cca513-677b-4013-82b7-6e20d1c271e9" name="error-handling:\response" />
		
</on-error-continue>
		<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="09cdde76-926c-4460-ba0c-d0f7025efaa6" type="APIKIT:NOT_ACCEPTABLE" >
			<ee:transform doc:name="Set HTTP Status = 406 &amp; errCode" doc:id="93de9710-e3f6-478d-a874-0a822362560b">
				<ee:message />
				<ee:variables>
					<ee:set-variable variableName="httpStatus"><![CDATA[%dw 2.0
output application/java
---
406]]></ee:set-variable>
					<ee:set-variable variableName="errCode"><![CDATA[%dw 2.0
output application/java
---
Mule::p('error.notAcceptable.code')]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<flow-ref doc:name="error-handling:\response" doc:id="c1f13806-612b-49cf-b318-3050c0a19ca2" name="error-handling:\response" />
		
</on-error-continue>
		<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="e5453172-205e-40b0-9ace-576ca840f4a0" type="APIKIT:UNSUPPORTED_MEDIA_TYPE" >
			<ee:transform doc:name="Set HTTP Status = 415 &amp; errCode" doc:id="50caa066-2561-4ddb-8bc9-0290be712478">
				<ee:message />
				<ee:variables>
					<ee:set-variable variableName="httpStatus"><![CDATA[%dw 2.0
output application/java
---
415]]></ee:set-variable>
					<ee:set-variable variableName="errCode"><![CDATA[%dw 2.0
output application/java
---
Mule::p('error.unsupportedMediaType.code')]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<flow-ref doc:name="error-handling:\response" doc:id="ef81c409-9045-4307-957f-a7d4e21fab2a" name="error-handling:\response" />
		
</on-error-continue>	
		<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="f9785fa5-7955-49d0-bd30-950eeccf3d39" type="APIKIT:NOT_IMPLEMENTED" >
			<ee:transform doc:name="Set HTTP Status = 501 &amp; errCode" doc:id="a812ff9e-6508-496d-933c-5767e438fd71">
				<ee:message />
				<ee:variables>
					<ee:set-variable variableName="httpStatus"><![CDATA[%dw 2.0
output application/java
---
501]]></ee:set-variable>
					<ee:set-variable variableName="errCode"><![CDATA[%dw 2.0
output application/java
---
Mule::p('error.notImplemented.code')]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<flow-ref doc:name="error-handling:\response" doc:id="a4ce97b1-b8ae-471b-b892-8decbeccbf3c" name="error-handling:\response" />
		
</on-error-continue>	
	
	</error-handler>
	
	
	<error-handler name="error-handling-app" doc:id="caf43548-ef08-49a0-8f5f-d2638b15171d" >
		<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="a774fe00-a91f-4a8f-9cba-8dd715cefb5a" type="HTTP:BAD_REQUEST">
			<ee:transform doc:name="Set HTTP Status = 400 &amp; errCode" doc:id="d37a7970-db3b-4ff2-8e49-dada3b3d9106" >
				<ee:message />
				<ee:variables >
					<ee:set-variable variableName="httpStatus" ><![CDATA[%dw 2.0
output application/java
---
400]]></ee:set-variable>
					<ee:set-variable variableName="errCode" ><![CDATA[%dw 2.0
output application/java
---
Mule::p('error.badRequest.code')]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<flow-ref doc:name="error-handling:\response" doc:id="388126b1-a28a-4aba-864c-4eff6931932a" name="error-handling:\response" />
		</on-error-continue>
		<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="b3734a8a-8c63-4753-92db-ff81ce8630cd" type="HTTP:UNAUTHORIZED">
			<ee:transform doc:name="Set HTTP Status = 401 &amp; errCode" doc:id="050dc2b6-0ad0-4d86-96c3-9c0b4dbcabe7" >
				<ee:message />
				<ee:variables >
					<ee:set-variable variableName="httpStatus" ><![CDATA[%dw 2.0
output application/java
---
401]]></ee:set-variable>
					<ee:set-variable variableName="errCode" ><![CDATA[%dw 2.0
output application/java
---
Mule::p('error.notFound.code')]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<flow-ref doc:name="error-handling:\response" doc:id="600bb30b-9484-4216-b2df-9d3c3d7b18e8" name="error-handling:\response" />
		</on-error-continue>
		<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="a0897478-3635-4e98-b9b9-c36b9a86298e" type="HTTP:NOT_FOUND">
			<ee:transform doc:name="Set HTTP Status = 404 &amp; errCode" doc:id="114afeda-8e96-48c4-af54-36caaa4bf68a" >
				<ee:message />
				<ee:variables >
					<ee:set-variable variableName="httpStatus" ><![CDATA[%dw 2.0
output application/java
---
404]]></ee:set-variable>
					<ee:set-variable variableName="errCode" ><![CDATA[%dw 2.0
output application/java
---
Mule::p('error.notFound.code')]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<flow-ref doc:name="error-handling:\response" doc:id="bb083bc2-c75d-43f3-bba9-04574818e3d6" name="error-handling:\response" />
		</on-error-continue>
		<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="932859c3-9ee0-43d5-8df8-87fa7f585435" type="HTTP:UNSUPPORTED_MEDIA_TYPE">
			<ee:transform doc:name="Set HTTP Status = 415 &amp; errCode" doc:id="b4bacec9-653e-4584-a90e-884300ab8cfa" >
				<ee:message />
				<ee:variables >
					<ee:set-variable variableName="httpStatus" ><![CDATA[%dw 2.0
output application/java
---
415]]></ee:set-variable>
					<ee:set-variable variableName="errCode" ><![CDATA[%dw 2.0
output application/java
---
Mule::p('error.unsupportedMediaType.code')]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<flow-ref doc:name="error-handling:\response" doc:id="c0973efd-cc9a-4538-ac8c-8241915f39b2" name="error-handling:\response" />
		</on-error-continue>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="aa8251eb-884f-4c60-b20f-d708256b239b" type="EMPLOYEE_EHR_SAPI:NOT_FOUND">
			<ee:transform doc:name="Capture Error Details" doc:id="b7f2d295-b4e8-4e04-b885-2b1cf7896d45">
				<ee:message>
					<ee:set-payload resource="dwl/captureErrors.dwl" />
				</ee:message>
			</ee:transform>
		</on-error-propagate>
		<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="fac8ec94-fa10-4b48-bfab-c9753f1116c2" type="ANY">
			<ee:transform doc:name="Set HTTP Status = 500 &amp; errCode" doc:id="164bbcdd-1267-4e0c-acfa-6b09d986f670">
				<ee:message />
				<ee:variables>
					<ee:set-variable variableName="httpStatus"><![CDATA[%dw 2.0
output application/java
---
500]]></ee:set-variable>
					<ee:set-variable variableName="errCode"><![CDATA[%dw 2.0
output application/java
---
Mule::p('error.any.code')]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<flow-ref doc:name="error-handling:\response" doc:id="669ec18a-34ab-4789-a92e-d426aa7b3a06" name="error-handling:\response" />
		</on-error-continue>
	</error-handler>
	
	<!-- This service is mandatory to create the REQUEST_APP_ERROR:BAD_TREATMENT Error and make the app buildable if no used -->
	<!-- This service is mandatory to create the SAPI:BAD_REQUEST Error and make the app buildable if no used -->
	
	<sub-flow name="error-handling:\response" doc:id="d3262c72-5d02-4775-9a04-41a6cb176ff5" >
		<json-logger:logger doc:id="986ae795-f10b-4aac-9c9e-f1a74aabfc6c" config-ref="JSON_Logger_Config" message="Transaction Failed!" tracePoint="END" doc:name="Failed Logger" priority="ERROR" category="${log.external.categoryAdditivityEnabled}">
			<json-logger:content ><![CDATA[#[import modules::JSONLoggerModule output application/json ---
{
    payload:  error.errorType.namespace as String ++ ":" ++ error.errorType.identifier as String ++ ", " ++  error.detailedDescription
}]]]></json-logger:content>
		</json-logger:logger>
		<choice doc:name="Payload structure is SOAP?">
			<!-- SOAP REQUEST -->
            <when expression="#[(vars.soapfaultResponse default false) == true]">
            	<ee:transform doc:name="Set Error Response" doc:id="0ffe807a-df86-476e-877f-94b7866f1cd4">
					<ee:message>
						<ee:set-payload resource="dwl/error-response-for-soap.dwl" />
					</ee:message>
				</ee:transform>
			</when>			
	        <otherwise>
	            <ee:transform doc:name="Set Error Response" doc:id="0ffe807a-df86-476e-877f-94b7866f1cd4">
					<ee:message>
						<ee:set-payload resource="dwl/error-response-for-not-soap.dwl" />
					</ee:message>
				</ee:transform>
	        </otherwise>
	    </choice>
		
		
		
	</sub-flow>
</mule>
